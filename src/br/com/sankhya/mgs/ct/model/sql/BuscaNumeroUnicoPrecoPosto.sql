SELECT NUCONTREVENTO FROM (
SELECT NUCONTREVENTO, NROOCORRENCIA, MAX(NROOCORRENCIA) OVER() AS MAXNROOCORRENCIA
FROM MGSTCTCONTRVLRPS
WHERE NUMCONTRATO = :NUMCONTRATO
AND CODTPN = :CODTPN
AND CODTIPOPOSTO = :CODTIPOPOSTO
AND MGSTCTCONTRVLRPS.CODEVENTO = (select mgstctevtapt.codevtvlr from mgstctevtapt where codevento = :CODEVENTO and rownum <= 1)
AND TRUNC(SYSDATE) BETWEEN TRUNC(DTINICIO) AND TRUNC(DTFIM)
AND ALIQISS = ( NVL(SUBSTR(busca_tributos(:v_codunidadefatura,:v_codtipofatura,'F'),11,5)+0,0)*1 )
) WHERE NROOCORRENCIA = MAXNROOCORRENCIA